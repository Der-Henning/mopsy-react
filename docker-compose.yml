version: '3'
volumes:
  db:
  solr:
  solr_config:
services:
  web:
    image: derhenning/mopsy:latest
    restart: always
    ports:
      - 4321:80
    volumes:
      - solr_config:/usr/mopsy/solr_configset
      - /volume1/media/books:/mnt/books:ro
    environment:
      MOPSY_APP_NAME: MOPSY Search
      MOPSY_PORT: 80
      MOPSY_JSON_IDENTATION: 4
      MOPSY_MYSQL_DATABASE: mopsy
      MOPSY_MYSQL_HOST: db
      MOPSY_MYSQL_PORT: 3306
      MOPSY_MYSQL_USERNAME: mopsy
      MOPSY_MYSQL_PASSWORD: mopsy
      MOPSY_SOLR_HOST: solr
      MOPSY_SOLR_PORT: 8983
      MOPSY_SOLR_CORE: mopsy
      MOPSY_MYPRIVATEKEY: myprivatekey
      MOPSY_SESSIONKEY: myprivatekey
      MOPSY_SALT_ROUNDS: 10
      MOPSY_HITS_PER_PAGE: 10
      MOPSY_CRAWLERS: calibre
  db:
    image: mariadb
    command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW
    volumes:
      - db:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=mopsy
      - MYSQL_PASSWORD=mopsy
      - MYSQL_DATABASE=mopsy
      - MYSQL_USER=mopsy
  solr:
    image: solr:8.6
    restart: always
    environment:
      - SOLR_HEAP=1g
    volumes:
      - solr:/var/solr
      - solr_config:/opt/solr/server/solr/configsets/myconfig:ro
    command:
      solr-precreate mopsy /opt/solr/server/solr/configsets/myconfig
  calibre:
    image: derhenning/mopsy-crawler:latest
    volumes:
      - /volume1/media/books:/mnt/books:ro
    environment:
      CRAWLER_TYPE: calibre
      CRAWLER_NAME: Calibre V1.0
      CALIBRE_PATH: /mnt/books
      MOPSY_SOLR_HOST: solr
      MOPSY_SOLR_PORT: 8983
      MOPSY_SOLR_CORE: mopsy
      MOPSY_SOLR_PREFIX: calibre
